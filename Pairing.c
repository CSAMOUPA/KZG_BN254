#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include "Fp.h"
#include "Fp2.h"
#include "Fp6.h"
#include "Fp12.h"
#include "int256.h"
#include "int512.h"
#include "EC.h"
#include "Pairing.h"

const long unsigned int OK = 0x8000000000000000;

Fp12 Millerloop(G1 P, G2 Q, int256 r)
{	
	int i = 255;
	
	while ((r.u3 && OK) == 0)
	{
		r = shift_left_256(r);
		i = i-1;
	} 
	r = shift_left_256(r);
	G1 T = P;
	Fp12 f1 = Fp12_one();
	Fp12 f2 = Fp12_one();
	Fp12 f;

	while (i)
	{	
		printf("%d\n",i );
		if (G1_equal(G1_add(T,T),G1_zero()))
		{
			f1 = Fp12_mul_by_Fp6(f1,Fp6xFp_add(Q.x,Fp_opp(T.x)));
		}
		else {
		Fp m = Fp_div(Fp_mul(Fp_from_int(3),Fp_mul(P.x,P.x)), (Fp_from_int(2),P.y));
		Fp12 l = Fp12xFp6_add(Q.y,Fp6xFp_add(Fp6_mul_by_scalar(Fp6xFp_add(Q.x,Fp_opp(T.x)), Fp_opp(m)),Fp_opp(T.y)));
		f1 = Fp12_mul(Fp12_mul(f1,f1), l);
		f2 = Fp12_mul_by_Fp6(Fp12_mul(f2,f2),Fp6xFp_add(Q.x,Fp_add(Fp_add(T.x,T.x),Fp_opp(Fp_mul(m,m)))));
		T = G1_add(T,T);
		}

		if (r.u3 & OK){
		if (G1_equal(G1_add(T,P),G1_zero()))
		{
			f1 = Fp12_mul_by_Fp6(f1,Fp6xFp_add(Q.x,Fp_opp(T.x)));
		}
		else {
			Fp m1 = Fp_div(Fp_sub(T.y,P.y),Fp_sub(T.x, P.x));
			Fp12 l = Fp12xFp6_add(Q.y,Fp6xFp_add(Fp6_mul_by_scalar(Fp6xFp_add(Q.x,Fp_opp(T.x)), Fp_opp(m1)),Fp_opp(T.y)));
			f1 = Fp12_mul(f1,l);
			f2 = Fp12_mul_by_Fp6(f2,Fp6xFp_add(Q.x,Fp_add(Fp_add(P.x,T.x),Fp_opp(Fp_mul(m1,m1)))));
			T = G1_add(T,P); }
		}
		r = shift_left_256(r);
		i = i-1;
	}

	f = Fp12_div(f1,f2);
	return f; 
}


Fp12 exp_par_un_mega_int(Fp12 base){
char chaine[] = "101111010010110110110111001001011100000010000011111101110110101101111100010000011111010010000010111100100001000010110101000011101111110110001101101001101100011111111101101010000111000111000100000001010111110011111101111011111000101110000111100011000010100111001110111011100101001111111011000000110110101111000101010100011001101011001000111000001110100101110100111110110000111101000101011010110101010010010011011000111101110000110001010100111011111110111000011011110110001100001110110010000100110111011111100101011000111010000010011010000110110111000001011000100001111110011100101110110011101010110111011110101000110111100100000011011001001010011000011111011001110110101110101010111110010111011110000111000011101000100011010101110001101100100011111110111100000111100000010011011000011110010001000011101011100111011111110101101101100011101000101010001000100110010001001000011111110010100101000000101010001011000111011101101100111101000101010000011000101100110100001111101100100000000101011101111111000110011001101000010001001001101011101101001111001100010010001010100000101101000011010110000000101101001001101000110001111101101010101011011010100100000100101001010011000000110011000100111010111110010101100110010001010110100011011111110001010000111000010110010010001010010001011010010010100001111000111010010100011001010110000100011010100011111011010000000100011010001100110111101000000010000010001000111011001000000011100000111010111010111010000111010101011100111111100001000001111010110011110011101010101111101101000000010010010100111001000000011011111000000001000010000101101011101100010000110011110100001100001011000011110011011110000101011010110100001011011011100011011100010101010001010001110010010011101110100100111101111110110001000010000010011011110000110111010100101000000011011001001011100101011000000000101001000111010010110011010110010101100110010010000001010011111101111000110111110010101000000010111011010011101010010001001110101011001100010111100110010000011011101110101101111101000010001111111001101000101100101111111000000100111011100011010001010001011101101010010000000000101001101110101110111001111101110110101101110110100111000111000111111100111000000100011100010000010000010100100110001010010100010110111011101000010110011010001100001110111110011010011010001111000010001100001001011101001101100000110101011000011000010000011101011101100110111110011100100111010101011100001011101101111111101111100000010011000111111010001010011011000011110001110110000011000000110111101000000111011110111100110101011010010010110110100011011000010001000000101011011010111001101100101011100100011000100000110111111110101001011110001001011011101000010010101011101101000000101001001110111110110111111001010100010100100011101001001000011010010110010010110110010011001010100001101111000100100000";

Fp12 ans = Fp12_one();
int i;
for (i=0; i<2790; i++)
{	
	if (chaine[2789-i])
	{
	ans = Fp12_mul(ans,base);
	}
	base = Fp12_mul(base,base);
}
return ans; 

}

Fp12 Tate_pairing(G1 P, G2 Q, int256 r)
{
	Fp12 f = Millerloop(P,Q,r);
		f = exp_par_un_mega_int(f);
	return f;
}

Fp12 Weil_pairing(G1 P, G2 Q, int256 r)
{
	Fp12 f;

	return f;
}
